name: Publish Wheels on PyPi

on:
    release:
        types: [published]

    workflow_dispatch:

jobs:
    build_wheel:
        name: Build wheel
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-python@v3

            - name: Checkout dependencies
              run: python -m pip install wheel setuptools numpy

            - name: Create binary distribution
              run: python setup.py bdist_wheel

            - name: Install wheel
              run: pip install ./dist/sihm*.whl

            - name: Upload distribution
              uses: actions/upload-artifact@v3
              with:
                  name: wheel
                  path: ./dist/sihm*.whl

    upload_wheels:
        name: Upload wheels to PyPI
        runs-on: ubuntu-latest
        needs: [build_wheel]
        steps:
            - uses: actions/download-artifact@v3
              with:
                  name: wheel
                  path: ./dist

            - name: Publish package to PyPI test
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  user: __token__
                  password: ${{ secrets.PYPI_API_TOKEN }}
